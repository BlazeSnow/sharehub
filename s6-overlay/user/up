#!/bin/bash

USERNAME=${USERNAME:-sharehub}
PASSWORD=${PASSWORD:-password}
SHAREPATH=${SHAREPATH:-/sharehub}
WRITABLE=${WRITABLE:-true}
GUEST=${GUEST:-false}
TZ=${TZ:-UTC}
FTP=${FTP:-true}
SSH=${SSH:-false}
SFTP=${SFTP:-true}
WEBDAV=${WEBDAV:-true}
SMB=${SMB:-true}
NFS=${NFS:-true}

# ---以下为FTP---

if [ "$FTP" != "true" ]; then return; fi
echo "正在配置FTP"

mkdir -p /etc/vsftpd
cat >/etc/vsftpd/vsftpd.conf <<EOF
listen=YES
listen_ipv6=NO
connect_from_port_20=YES
pasv_enable=${FTP_PASSIVE:-YES}
pasv_min_port=21100
pasv_max_port=21110
pasv_address_resolve=NO
userlist_enable=YES
userlist_file=/etc/vsftpd/user_list
userlist_deny=NO
dirmessage_enable=YES
xferlog_enable=YES
xferlog_std_format=YES
chroot_local_user=YES
allow_writeable_chroot=YES
local_enable=YES
EOF

if [ "$WRITABLE" == "true" ]; then
    echo "write_enable=YES" >>/etc/vsftpd/vsftpd.conf
fi

if [ "$GUEST" == "true" ]; then
    echo "anonymous_enable=YES" >>/etc/vsftpd/vsftpd.conf
    echo "anon_root=$SHAREPATH" >>/etc/vsftpd/vsftpd.conf
    echo "no_anon_password=YES" >>/etc/vsftpd/vsftpd.conf
    if [ "$WRITABLE" == "true" ]; then
        echo "anon_upload_enable=YES" >>/etc/vsftpd/vsftpd.conf
        echo "anon_mkdir_write_enable=YES" >>/etc/vsftpd/vsftpd.conf
    fi
else
    echo "anonymous_enable=NO" >>/etc/vsftpd/vsftpd.conf
fi

echo "$USERNAME" >/etc/vsftpd/user_list

# ---以下为SFTP---

if [ "$SFTP" != "true" ] && [ "$SSH" != "true" ]; then return; fi
echo "正在配置SFTP/SSH"

# 生成SSH密钥
ssh-keygen -A 2>/dev/null || true

# 备份原始配置
cp /etc/ssh/sshd_config /etc/ssh/sshd_config.bak 2>/dev/null || true

cat >>/etc/ssh/sshd_config <<EOF

# ShareHub SFTP Configuration
Match User $USERNAME
    ChrootDirectory %h
    PasswordAuthentication yes
    AllowTcpForwarding no
    X11Forwarding no
EOF

if [ "$SSH" != "true" ]; then
    echo "仅启用SFTP"
    echo "    ForceCommand internal-sftp" >>/etc/ssh/sshd_config
else
    echo "同时启用SSH和SFTP"
fi

# ---以下为SMB---

if [ "$SMB" != "true" ]; then return; fi
echo "正在配置SMB"

# 添加samba用户
(
    echo "$PASSWORD"
    echo "$PASSWORD"
) | smbpasswd -a -s "$USERNAME" 2>/dev/null || true

cat >/etc/samba/smb.conf <<EOF
[global]
    workgroup = WORKGROUP
    server string = ShareHub Samba Server
    security = user
    map to guest = bad user
    log file = /var/log/samba/log.%m
    max log size = 50
    
[share]
    path = $SHAREPATH
    browseable = yes
    guest ok = ${GUEST:-no}
    read only = $([ "$WRITABLE" == "true" ] && echo "no" || echo "yes")
    writable = $([ "$WRITABLE" == "true" ] && echo "yes" || echo "no")
    valid users = $USERNAME $([ "$GUEST" == "true" ] && echo "nobody")
EOF

# ---以下为NFS---

if [ "$NFS" != "true" ]; then return; fi
echo "正在配置NFS"

echo -n "$SHAREPATH" >/etc/exports
local nfs_perms=$([ "$WRITABLE" == "true" ] && echo "rw" || echo "ro")
echo " *(${nfs_perms},sync,no_subtree_check,insecure,no_root_squash)" >>/etc/exports

# ---以下为webdav---

if [ "$WEBDAV" != "true" ]; then return; fi

# 生成密码哈希
PASSWORD_HASH=$(caddy hash-password --plaintext "$PASSWORD" 2>/dev/null || echo "$PASSWORD")

cat >/etc/caddy/Caddyfile <<EOF
:80 {
    # 文件浏览器
    route /* {
        basicauth {
            $USERNAME $PASSWORD_HASH
        }
        file_server browse {
            root $SHAREPATH
        }
    }
    
    # WebDAV 接口
    route /webdav/* {
        basicauth {
            $USERNAME $PASSWORD_HASH
        }
        webdav {
            root $SHAREPATH
            prefix /webdav
EOF

if [ "$WRITABLE" != "true" ]; then
    cat >>/etc/caddy/Caddyfile <<EOF
            # 只读模式 - 禁止写操作
            read_only
EOF
fi

cat >>/etc/caddy/Caddyfile <<EOF
        }
    }
    
    # 日志
    log {
        output file /var/log/caddy/access.log
    }
}
EOF

# 创建日志目录
mkdir -p /var/log/caddy
chown -R caddy:caddy /var/log/caddy 2>/dev/null || true
