#!/bin/bash

USERNAME=${USERNAME:-sharehub}
PASSWORD=${PASSWORD:-password}
SHAREPATH=${SHAREPATH:-/sharehub}
WRITABLE=${WRITABLE:-true}
GUEST=${GUEST:-false}
SSH=${SSH:-false}

# ---以下为FTP---



# ---以下为SFTP---



# ---以下为SMB---



# ---以下为NFS---

echo "正在配置 NFS 服务"

echo -n "$SHAREPATH" >/etc/exports

nfs_perms=$([ "$WRITABLE" == "true" ] && echo "rw" || echo "ro")

echo " *(${nfs_perms},sync,no_subtree_check,insecure,no_root_squash)" >>/etc/exports

# ---以下为webdav---

echo "正在配置 WebDAV 服务"

PASSWORD_HASH=$(caddy hash-password --plaintext "$PASSWORD" 2>/dev/null || echo "$PASSWORD")

mkdir -p /etc/caddy
touch /etc/caddy/Caddyfile

if [ "$WRITABLE" = "false" ]; then
    cat >/etc/caddy/Caddyfile <<EOF
{
    order webdav before file_server
}

:80 {
    root * $SHAREPATH
    
    @readonly_methods method GET HEAD OPTIONS PROPFIND
    
    route {
        webdav @readonly_methods
        file_server browse
        respond * "WebDAV is read-only" 405
    }
}
EOF
else
    cat >/etc/caddy/Caddyfile <<EOF
{
    order webdav before file_server
}

:80 {
    root * $SHAREPATH
    webdav
    file_server browse
}
EOF
fi

mkdir -p /var/log/caddy
chown -R caddy:caddy /var/log/caddy 2>/dev/null || true
